<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RunLog - ëŸ¬ë‹ ê¸°ë¡ ì•„ì¹´ì´ë¸Œ</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * { font-family: 'Inter', sans-serif; }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .auth-card { animation: fadeIn 0.5s ease-out; }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .slide-up { animation: slideUp 0.3s ease-out; }
    
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #64748b; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }
    
    .image-upload-container {
      position: relative;
      width: 100%;
      aspect-ratio: 1;
      border: 2px dashed #cbd5e1;
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .image-upload-container:hover {
      border-color: #1e40af;
      background-color: #f8fafc;
    }
    
    .image-upload-container.has-image { border: none; }
    
    .image-preview {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .upload-placeholder {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #94a3b8;
    }

    .pr-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 16px;
      padding: 24px;
      color: white;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
  </style>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            navy: {
              50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1',
              400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155',
              800: '#1e293b', 900: '#0f172a',
            }
          }
        }
      }
    }
  </script>
</head>
<body class="bg-navy-50">
  <div id="root"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { 
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
      signOut, onAuthStateChanged, updateProfile, updatePassword, sendPasswordResetEmail
    } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
    import { 
      getFirestore, collection, addDoc, query, where, orderBy, getDocs,
      doc, getDoc, setDoc, updateDoc, deleteDoc, Timestamp 
    } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
    import { 
      getStorage, ref, uploadBytes, getDownloadURL
    } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js';

    const firebaseConfig = {
      apiKey: "AIzaSyA4KFdLVKVy6WdAfTGuLWDJsV_tcuNp7kw",
      authDomain: "run-log-31420.firebaseapp.com",
      projectId: "run-log-31420",
      storageBucket: "run-log-31420.firebasestorage.app",
      messagingSenderId: "325067679087",
      appId: "1:325067679087:web:727201211a34ac6c1fb49a",
    };

    const app = initializeApp(firebaseConfig);
    window.firebaseAuth = getAuth(app);
    window.firebaseDb = getFirestore(app);
    window.firebaseStorage = getStorage(app);
    window.firebaseModules = {
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
      onAuthStateChanged, updateProfile, updatePassword, sendPasswordResetEmail,
      collection, addDoc, query, where, orderBy, getDocs, doc, getDoc,
      setDoc, updateDoc, deleteDoc, Timestamp,
      ref, uploadBytes, getDownloadURL
    };
  </script>

  <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.min.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const auth = window.firebaseAuth;
    const db = window.firebaseDb;
    const storage = window.firebaseStorage;
    const {
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
      onAuthStateChanged, updateProfile, updatePassword, sendPasswordResetEmail,
      collection, addDoc, query, where, orderBy, getDocs, doc, getDoc,
      setDoc, updateDoc, deleteDoc, Timestamp,
      ref, uploadBytes, getDownloadURL
    } = window.firebaseModules;

    const RACE_DATABASE = [
      { id: 1, name: 'ì„œìš¸êµ­ì œë§ˆë¼í†¤', date: '2025-03-16' },
      { id: 2, name: 'ë™ì•„ë§ˆë¼í†¤', date: '2025-03-23' },
      { id: 3, name: 'ì¤‘ì•™ì„œìš¸ë§ˆë¼í†¤', date: '2025-11-03' },
      { id: 4, name: 'ì¶˜ì²œë§ˆë¼í†¤', date: '2025-10-26' },
      { id: 5, name: 'ëŒ€êµ¬êµ­ì œë§ˆë¼í†¤', date: '2025-04-06' },
    ];

    const RACE_TYPES = {
      '5K': 5,
      '10K': 10,
      'HALF': 21.0975,
      'FULL': 42.195,
      'CUSTOM': null
    };

    const formatTime = (seconds) => {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      
      if (hours > 0) {
        return `${hours}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      }
      return `${minutes}:${String(secs).padStart(2, '0')}`;
    };

    const calculatePace = (distanceKm, timeSeconds) => {
      const paceSeconds = timeSeconds / distanceKm;
      const minutes = Math.floor(paceSeconds / 60);
      const seconds = Math.floor(paceSeconds % 60);
      return `${minutes}:${String(seconds).padStart(2, '0')}`;
    };

    const compressImage = async (file) => {
      const options = {
        maxSizeMB: 0.5,
        maxWidthOrHeight: 1920,
        useWebWorker: true
      };
      try {
        return await imageCompression(file, options);
      } catch (error) {
        console.error('ì´ë¯¸ì§€ ì••ì¶• ì‹¤íŒ¨:', error);
        return file;
      }
    };

    const checkNicknameExists = async (nickname) => {
      const usersRef = collection(db, 'users');
      const snapshot = await getDocs(usersRef);
      return snapshot.docs.some(doc => doc.data().nickname === nickname);
    };

    const validatePassword = (password) => {
      const regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*[!@#$%^&*]).{8,}$/;
      return regex.test(password);
    };

    const AuthForm = ({ onAuthSuccess }) => {
      const [isLogin, setIsLogin] = useState(true);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [passwordConfirm, setPasswordConfirm] = useState('');
      const [nickname, setNickname] = useState('');
      const [nicknameChecked, setNicknameChecked] = useState(false);
      const [nicknameCheckStatus, setNicknameCheckStatus] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      const [showPasswordReset, setShowPasswordReset] = useState(false);
      const [resetEmail, setResetEmail] = useState('');
      const [showSuccessModal, setShowSuccessModal] = useState(false);

      const handleNicknameCheck = async () => {
        if (!nickname.trim()) {
          setError('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        setNicknameCheckStatus('checking');
        setError('');

        try {
          const exists = await checkNicknameExists(nickname);
          if (exists) {
            setNicknameCheckStatus('taken');
            setNicknameChecked(false);
            setError('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.');
          } else {
            setNicknameCheckStatus('available');
            setNicknameChecked(true);
            setError('');
          }
        } catch (err) {
          setNicknameCheckStatus('');
          setError('ë‹‰ë„¤ì„ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      };

      const handleNicknameChange = (e) => {
        setNickname(e.target.value);
        setNicknameChecked(false);
        setNicknameCheckStatus('');
        setError('');
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          if (isLogin) {
            await signInWithEmailAndPassword(auth, email, password);
          } else {
            if (!nicknameChecked) {
              setError('ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸ì„ í•´ì£¼ì„¸ìš”.');
              setLoading(false);
              return;
            }

            if (!validatePassword(password)) {
              setError('ë¹„ë°€ë²ˆí˜¸ëŠ” ëŒ€ì†Œë¬¸ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ í¬í•¨í•˜ì—¬ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
              setLoading(false);
              return;
            }
            
            if (password !== passwordConfirm) {
              setError('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
              setLoading(false);
              return;
            }

            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            
            await setDoc(doc(db, 'users', userCredential.user.uid), {
              nickname,
              email,
              createdAt: Timestamp.now()
            });

            await updateProfile(userCredential.user, { displayName: nickname });
            
            setShowSuccessModal(true);
            setTimeout(() => {
              setShowSuccessModal(false);
              onAuthSuccess();
            }, 2000);
          }
        } catch (err) {
          if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password' || err.code === 'auth/invalid-credential') {
            setError('ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ í•œ ë²ˆ í™•ì¸í•´ì£¼ì„¸ìš”.');
          } else if (err.code === 'auth/email-already-in-use') {
            setError('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.');
          } else {
            setError('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          }
        } finally {
          setLoading(false);
        }
      };

      const handlePasswordReset = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          await sendPasswordResetEmail(auth, resetEmail);
          alert('ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì´ë©”ì¼ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
          setShowPasswordReset(false);
          setResetEmail('');
        } catch (err) {
          setError('ì´ë©”ì¼ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
        } finally {
          setLoading(false);
        }
      };

      return (
        <>
          <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-navy-800 via-navy-700 to-navy-600 p-4">
            <div className="auth-card bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
              <div className="text-center mb-8">
                <h1 className="text-4xl font-bold mb-2 text-navy-900">RunLog</h1>
                <p className="text-navy-600 text-base">ë‹¹ì‹ ì˜ ëŸ¬ë‹ ì—¬ì •ì„ ê¸°ë¡í•˜ì„¸ìš”</p>
              </div>

              <form onSubmit={handleSubmit} className="space-y-4">
                {!isLogin && (
                  <div>
                    <label className="block text-sm font-semibold text-navy-700 mb-2">ë‹‰ë„¤ì„</label>
                    <div className="flex gap-2">
                      <input
                        type="text"
                        value={nickname}
                        onChange={handleNicknameChange}
                        className={`flex-1 px-4 py-3 rounded-lg border-2 transition-colors ${
                          nicknameCheckStatus === 'available' 
                            ? 'border-green-500 focus:border-green-600' 
                            : nicknameCheckStatus === 'taken'
                            ? 'border-red-500 focus:border-red-600'
                            : 'border-navy-200 focus:border-navy-600'
                        } focus:outline-none`}
                        required
                      />
                      <button
                        type="button"
                        onClick={handleNicknameCheck}
                        disabled={nicknameCheckStatus === 'checking' || !nickname.trim()}
                        className="px-4 py-3 bg-navy-600 text-white text-sm font-semibold rounded-lg hover:bg-navy-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap"
                      >
                        {nicknameCheckStatus === 'checking' ? 'í™•ì¸ì¤‘...' : 'ì¤‘ë³µ í™•ì¸'}
                      </button>
                    </div>
                    {nicknameCheckStatus === 'available' && (
                      <p className="text-xs text-green-600 mt-1">âœ“ ì‚¬ìš© ê°€ëŠ¥í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.</p>
                    )}
                    {nicknameCheckStatus === 'taken' && (
                      <p className="text-xs text-red-600 mt-1">âœ— ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.</p>
                    )}
                  </div>
                )}
                
                <div>
                  <label className="block text-sm font-semibold text-navy-700 mb-2">ì´ë©”ì¼</label>
                  <input
                    type="email"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    className="w-full px-4 py-3 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none transition-colors"
                    required
                  />
                </div>

                <div>
                  <label className="block text-sm font-semibold text-navy-700 mb-2">ë¹„ë°€ë²ˆí˜¸</label>
                  <input
                    type="password"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    className="w-full px-4 py-3 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none transition-colors"
                    required
                  />
                  {!isLogin && (
                    <p className="text-xs text-navy-500 mt-1">ëŒ€ì†Œë¬¸ì, íŠ¹ìˆ˜ë¬¸ì í¬í•¨ 8ì ì´ìƒ</p>
                  )}
                </div>

                {!isLogin && (
                  <div>
                    <label className="block text-sm font-semibold text-navy-700 mb-2">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                    <input
                      type="password"
                      value={passwordConfirm}
                      onChange={(e) => setPasswordConfirm(e.target.value)}
                      className="w-full px-4 py-3 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none transition-colors"
                      required
                    />
                  </div>
                )}

                {error && (
                  <div className="bg-red-50 text-red-600 px-4 py-3 rounded-lg text-sm">
                    {error}
                  </div>
                )}

                <button
                  type="submit"
                  disabled={loading}
                  className="w-full bg-navy-700 text-white font-semibold py-3 rounded-lg hover:bg-navy-800 transition-colors disabled:opacity-50"
                >
                  {loading ? 'ì²˜ë¦¬ì¤‘...' : (isLogin ? 'ë¡œê·¸ì¸' : 'íšŒì›ê°€ì…')}
                </button>
              </form>

              <div className="mt-6 text-center space-y-2">
                <div className="text-sm text-navy-600">
                  {isLogin ? 'ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? ' : 'ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? '}
                  <button
                    onClick={() => {
                      setIsLogin(!isLogin);
                      setError('');
                    }}
                    className="text-navy-700 font-semibold hover:text-navy-900 transition-colors"
                  >
                    {isLogin ? 'íšŒì›ê°€ì…' : 'ë¡œê·¸ì¸'}
                  </button>
                </div>
                
                {isLogin && (
                  <button
                    onClick={() => setShowPasswordReset(true)}
                    className="text-sm text-navy-600 hover:text-navy-800 transition-colors"
                  >
                    ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°
                  </button>
                )}
              </div>
            </div>
          </div>

          {showPasswordReset && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 w-full max-w-md slide-up">
                <h2 className="text-2xl font-bold text-navy-900 mb-4">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</h2>
                <form onSubmit={handlePasswordReset} className="space-y-4">
                  <div>
                    <label className="block text-sm font-semibold text-navy-700 mb-2">ì´ë©”ì¼</label>
                    <input
                      type="email"
                      value={resetEmail}
                      onChange={(e) => setResetEmail(e.target.value)}
                      className="w-full px-4 py-3 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none"
                      placeholder="ê°€ì…í•œ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”"
                      required
                    />
                  </div>
                  {error && (
                    <div className="bg-red-50 text-red-600 px-4 py-3 rounded-lg text-sm">
                      {error}
                    </div>
                  )}
                  <div className="flex gap-2">
                    <button
                      type="submit"
                      disabled={loading}
                      className="flex-1 bg-navy-700 text-white font-semibold py-3 rounded-lg hover:bg-navy-800 transition-colors"
                    >
                      ì „ì†¡
                    </button>
                    <button
                      type="button"
                      onClick={() => {
                        setShowPasswordReset(false);
                        setResetEmail('');
                        setError('');
                      }}
                      className="flex-1 bg-navy-100 text-navy-700 font-semibold py-3 rounded-lg hover:bg-navy-200 transition-colors"
                    >
                      ì·¨ì†Œ
                    </button>
                  </div>
                </form>
              </div>
            </div>
          )}

          {showSuccessModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-8 text-center slide-up">
                <div className="text-6xl mb-4">ğŸ‰</div>
                <h2 className="text-2xl font-bold text-navy-900 mb-2">í™˜ì˜í•©ë‹ˆë‹¤!</h2>
                <p className="text-navy-600">íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
              </div>
            </div>
          )}
        </>
      );
    };

    const Profile = ({ user, userData, runs }) => {
      const [uploading, setUploading] = useState(false);

      const raceCount = runs.filter(run => run.runType === 'race').length;
      const casualCount = runs.filter(run => run.runType === 'casual').length;
      const hasFullMarathon = runs.some(run => run.raceType === 'FULL');

      const handlePhotoChange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        setUploading(true);
        try {
          const compressed = await compressImage(file);
          const storageRef = ref(storage, `profiles/${user.uid}`);
          await uploadBytes(storageRef, compressed);
          const photoURL = await getDownloadURL(storageRef);
          
          await updateProfile(auth.currentUser, { photoURL });
          window.location.reload();
          alert('í”„ë¡œí•„ ì‚¬ì§„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (error) {
          console.error('ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
          alert('ì‚¬ì§„ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        } finally {
          setUploading(false);
        }
      };

      return (
        <div className="bg-white rounded-xl shadow-sm p-6 mb-6">
          <div className="flex items-start gap-8">
            <div className="relative flex-shrink-0">
              <div 
                className="w-20 h-20 rounded-full overflow-hidden bg-navy-100 border-2 border-navy-200 cursor-pointer hover:opacity-80 transition-opacity"
                onClick={() => document.getElementById('profile-photo-upload').click()}
              >
                {uploading ? (
                  <div className="w-full h-full flex items-center justify-center">
                    <div className="animate-spin rounded-full h-8 w-8 border-2 border-navy-700 border-t-transparent"></div>
                  </div>
                ) : (
                  <img
                    src={user.photoURL || 'https://via.placeholder.com/80'}
                    alt="Profile"
                    className="w-full h-full object-cover"
                  />
                )}
              </div>
              <div className="absolute bottom-0 right-0 bg-navy-700 text-white rounded-full p-1.5 border-2 border-white cursor-pointer hover:bg-navy-800 transition-colors"
                onClick={() => document.getElementById('profile-photo-upload').click()}
              >
                <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
              </div>
              <input
                id="profile-photo-upload"
                type="file"
                accept="image/*"
                onChange={handlePhotoChange}
                className="hidden"
              />
            </div>

            <div className="flex-1">
              <h2 className="text-xl font-bold text-navy-900 mb-3">{userData?.nickname || user.displayName}</h2>
              <p className="text-sm text-navy-500">ëŒ€íšŒ {raceCount} Â· ì¼ìƒ {casualCount}</p>
              {hasFullMarathon && (
                <div className="mt-2 inline-flex items-center gap-1 px-3 py-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full text-xs font-bold">
                  <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                  </svg>
                  42.195km Finisher
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    const PersonalRecords = ({ runs }) => {
      const [displayedPRs, setDisplayedPRs] = useState([]);

      const calculatePRs = () => {
        const prs = {};
        runs.forEach(run => {
          const type = run.raceType;
          if (type !== 'CUSTOM' && type) {
            if (!prs[type] || run.time < prs[type].time) {
              prs[type] = run;
            }
          }
        });
        return Object.entries(prs).map(([type, run]) => ({ type, ...run }));
      };

      const prs = calculatePRs();

      useEffect(() => {
        if (prs.length > 0) {
          setDisplayedPRs([prs[0], prs[1] || prs[0]]);
        }
      }, [runs]);

      useEffect(() => {
        if (prs.length > 1) {
          const interval = setInterval(() => {
            setDisplayedPRs(current => {
              const nextIndex = (prs.findIndex(pr => pr.type === current[0].type) + 1) % prs.length;
              return [prs[nextIndex], current[0]];
            });
          }, 3000);
          return () => clearInterval(interval);
        }
      }, [prs.length]);

      if (prs.length === 0) {
        return (
          <div className="pr-card mb-6 text-center">
            <div className="text-4xl mb-2">ğŸ†</div>
            <h2 className="text-lg font-bold mb-1">ê°œì¸ ìµœê³  ê¸°ë¡</h2>
            <p className="text-sm opacity-90">ì²« ê¸°ë¡ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
          </div>
        );
      }

      return (
        <div className="pr-card mb-6 overflow-hidden relative" style={{ height: '140px' }}>
          <div className="absolute inset-0 transition-transform duration-500 ease-in-out" style={{ transform: 'translateY(0)' }}>
            {displayedPRs.map((pr, idx) => (
              <div key={`${pr.type}-${idx}`} className="text-center h-full flex flex-col justify-center" style={{ 
                transform: idx === 0 ? 'translateY(0)' : 'translateY(100%)',
                transition: 'transform 0.5s ease-in-out'
              }}>
                <div className="text-sm font-semibold opacity-90 mb-1">{pr.type}</div>
                <div className="text-4xl font-bold mb-2">{formatTime(pr.time)}</div>
                <div className="text-sm opacity-90">
                  {new Date(pr.date).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })}
                  {pr.raceName && ` | ${pr.raceName}`}
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    };

    const RunCard = ({ run, onClick }) => {
      const getDistanceLabel = () => {
        if (run.raceType === 'HALF') return 'HALF';
        if (run.raceType === 'FULL') return 'FULL';
        return `${run.distance}km`;
      };

      return (
        <div className="bg-white overflow-hidden cursor-pointer hover:opacity-90 transition-opacity" onClick={onClick}>
          {run.photos && run.photos.length > 0 && (
            <div className="relative w-full aspect-square bg-navy-100">
              <img
                src={run.photos[0]}
                alt="Run"
                className="w-full h-full object-cover"
              />
              
              {run.photos.length > 1 && (
                <div className="absolute top-3 right-3">
                  <div className="relative w-7 h-7">
                    <div className="w-5 h-5 border-2 border-white rounded-sm absolute top-0 left-0 opacity-60 shadow-lg"></div>
                    <div className="w-5 h-5 border-2 border-white rounded-sm absolute top-1.5 left-1.5 bg-black bg-opacity-30 shadow-lg"></div>
                  </div>
                </div>
              )}

              {run.runType === 'race' && (
                <div className="absolute top-2 left-2 bg-gradient-to-br from-yellow-400 to-yellow-600 text-white p-1.5 rounded-lg shadow-lg">
                  <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 3.5a1.5 1.5 0 013 0V4a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-.5a1.5 1.5 0 00-1.5 1.5v.5h-1a1 1 0 00-1 1v2a1 1 0 001 1h1v1.5a1.5 1.5 0 001.5 1.5v1a1 1 0 01-1 1H4a1 1 0 01-1-1v-1a1.5 1.5 0 001.5-1.5V16h1a1 1 0 001-1v-2a1 1 0 00-1-1h-1v-.5A1.5 1.5 0 003 10H2.5a1 1 0 01-1-1V6a1 1 0 011-1h3a1 1 0 001-1v-.5a1.5 1.5 0 013 0V4z"/>
                  </svg>
                </div>
              )}

              <div className="absolute bottom-0 right-0 bg-gradient-to-tl from-black/90 via-black/60 to-transparent pl-8 pt-8 pb-2 pr-2 rounded-tl-2xl">
                <div className="text-right">
                  <div className="text-white font-bold text-2xl leading-tight drop-shadow-lg">
                    {formatTime(run.time)}
                  </div>
                  <div className="text-white text-xs font-medium mt-0.5 opacity-90 drop-shadow-lg">
                    {getDistanceLabel()} Â· {new Date(run.date).toLocaleDateString('ko-KR', { month: 'numeric', day: 'numeric' })}
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    const SettingsModal = ({ user, userData, onClose, onSignOut }) => {
      const [nickname, setNickname] = useState(userData?.nickname || user.displayName || '');
      const [currentPassword, setCurrentPassword] = useState('');
      const [newPassword, setNewPassword] = useState('');
      const [newPasswordConfirm, setNewPasswordConfirm] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);

      const handleNicknameUpdate = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          if (nickname !== (userData?.nickname || user.displayName)) {
            const nicknameExists = await checkNicknameExists(nickname);
            if (nicknameExists) {
              setError('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.');
              setLoading(false);
              return;
            }
          }

          await updateProfile(auth.currentUser, { displayName: nickname });
          await updateDoc(doc(db, 'users', user.uid), { nickname });
          
          alert('ë‹‰ë„¤ì„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
          window.location.reload();
        } catch (err) {
          setError('ë‹‰ë„¤ì„ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        } finally {
          setLoading(false);
        }
      };

      const handlePasswordUpdate = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          if (!validatePassword(newPassword)) {
            setError('ë¹„ë°€ë²ˆí˜¸ëŠ” ëŒ€ì†Œë¬¸ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ í¬í•¨í•˜ì—¬ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
            setLoading(false);
            return;
          }

          if (newPassword !== newPasswordConfirm) {
            setError('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            setLoading(false);
            return;
          }

          await signInWithEmailAndPassword(auth, user.email, currentPassword);
          await updatePassword(auth.currentUser, newPassword);
          
          alert('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
          setCurrentPassword('');
          setNewPassword('');
          setNewPasswordConfirm('');
        } catch (err) {
          if (err.code === 'auth/wrong-password' || err.code === 'auth/invalid-credential') {
            setError('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          } else {
            setError('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md slide-up">
            <div className="flex justify-between items-center p-6 border-b border-navy-100">
              <h2 className="text-xl font-bold text-navy-900">ì„¤ì •</h2>
              <button
                onClick={onClose}
                className="text-navy-400 hover:text-navy-600 transition-colors"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>

            <div className="p-6 space-y-6">
              <form onSubmit={handleNicknameUpdate} className="space-y-3">
                <div>
                  <label className="block text-sm font-semibold text-navy-700 mb-2">ë‹‰ë„¤ì„</label>
                  <input
                    type="text"
                    value={nickname}
                    onChange={(e) => setNickname(e.target.value)}
                    className="w-full px-4 py-2 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none text-sm"
                    required
                  />
                </div>
                <button
                  type="submit"
                  disabled={loading}
                  className="w-full bg-navy-700 text-white py-2 rounded-lg hover:bg-navy-800 transition-colors text-sm font-semibold disabled:opacity-50"
                >
                  {loading ? 'ë³€ê²½ ì¤‘...' : 'ë‹‰ë„¤ì„ ë³€ê²½'}
                </button>
              </form>

              <div className="border-t border-navy-100 pt-6">
                <h3 className="text-sm font-semibold text-navy-700 mb-3">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
                <form onSubmit={handlePasswordUpdate} className="space-y-3">
                  <input
                    type="password"
                    value={currentPassword}
                    onChange={(e) => setCurrentPassword(e.target.value)}
                    className="w-full px-4 py-2 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none text-sm"
                    placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸"
                    required
                  />
                  <input
                    type="password"
                    value={newPassword}
                    onChange={(e) => setNewPassword(e.target.value)}
                    className="w-full px-4 py-2 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none text-sm"
                    placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸"
                    required
                  />
                  <input
                    type="password"
                    value={newPasswordConfirm}
                    onChange={(e) => setNewPasswordConfirm(e.target.value)}
                    className="w-full px-4 py-2 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none text-sm"
                    placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸"
                    required
                  />
                  <p className="text-xs text-navy-500">ëŒ€ì†Œë¬¸ì, íŠ¹ìˆ˜ë¬¸ì í¬í•¨ 8ì ì´ìƒ</p>
                  
                  {error && (
                    <div className="bg-red-50 text-red-600 px-3 py-2 rounded-lg text-xs">
                      {error}
                    </div>
                  )}
                  
                  <button
                    type="submit"
                    disabled={loading}
                    className="w-full bg-navy-700 text-white py-2 rounded-lg hover:bg-navy-800 transition-colors text-sm font-semibold disabled:opacity-50"
                  >
                    {loading ? 'ë³€ê²½ ì¤‘...' : 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½'}
                  </button>
                </form>
              </div>

              <div className="border-t border-navy-100 pt-6">
                <button
                  onClick={onSignOut}
                  className="w-full bg-red-50 text-red-600 py-2 rounded-lg hover:bg-red-100 transition-colors text-sm font-semibold"
                >
                  ë¡œê·¸ì•„ì›ƒ
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const RunDetailModal = ({ run, onClose, onDelete, onEdit }) => {
      const [currentImageIndex, setCurrentImageIndex] = useState(0);
      const [showMenu, setShowMenu] = useState(false);
      const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);

      const goToPrevious = () => {
        setCurrentImageIndex((prev) => (prev === 0 ? run.photos.length - 1 : prev - 1));
      };

      const goToNext = () => {
        setCurrentImageIndex((prev) => (prev === run.photos.length - 1 ? 0 : prev + 1));
      };

      const handleDelete = async () => {
        try {
          await deleteDoc(doc(db, 'runs', run.id));
          onDelete();
          onClose();
        } catch (error) {
          console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
          alert('ê¸°ë¡ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      };

      const handleShare = () => {
        alert('ê³µìœ  ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
      };

      const getDistanceLabel = () => {
        if (run.raceType === 'HALF') return 'HALF';
        if (run.raceType === 'FULL') return 'FULL';
        return `${run.distance}km`;
      };

      return (
        <div className="fixed inset-0 bg-black z-50 overflow-y-auto">
          <div className="min-h-screen">
            <div className="sticky top-0 bg-white border-b border-navy-100 z-10">
              <div className="flex items-center justify-between p-4">
                <button onClick={onClose} className="text-navy-900">
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                  </svg>
                </button>
                <h2 className="text-lg font-bold text-navy-900">ê²Œì‹œë¬¼</h2>
                <div className="relative">
                  <button onClick={() => setShowMenu(!showMenu)} className="text-navy-900">
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                    </svg>
                  </button>
                  {showMenu && (
                    <div className="absolute right-0 top-8 bg-white rounded-lg shadow-lg border border-navy-200 py-2 w-32 z-20">
                      <button
                        onClick={() => {
                          setShowMenu(false);
                          onEdit(run);
                        }}
                        className="w-full px-4 py-2 text-left text-sm text-navy-700 hover:bg-navy-50 transition-colors"
                      >
                        ìˆ˜ì •
                      </button>
                      <button
                        onClick={() => {
                          setShowMenu(false);
                          setShowDeleteConfirm(true);
                        }}
                        className="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 transition-colors"
                      >
                        ì‚­ì œ
                      </button>
                    </div>
                  )}
                </div>
              </div>
            </div>

            {run.photos && run.photos.length > 0 && (
              <div className="flex justify-center bg-black">
                <div className="relative w-full max-w-4xl aspect-square">
                  <img
                    src={run.photos[currentImageIndex]}
                    alt="Run"
                    className="w-full h-full object-contain"
                  />
                  
                  {run.photos.length > 1 && (
                    <>
                      {currentImageIndex > 0 && (
                        <button
                          className="absolute left-2 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-opacity-70 transition-all"
                          onClick={goToPrevious}
                        >
                          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                          </svg>
                        </button>
                      )}
                      
                      {currentImageIndex < run.photos.length - 1 && (
                        <button
                          className="absolute right-2 top-1/2 -translate-y-1/2 bg-black bg-opacity-50 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-opacity-70 transition-all"
                          onClick={goToNext}
                        >
                          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                          </svg>
                        </button>
                      )}

                      <div className="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-1.5">
                        {run.photos.map((_, idx) => (
                          <div
                            key={idx}
                            className={`w-1.5 h-1.5 rounded-full transition-all ${
                              idx === currentImageIndex ? 'bg-white w-6' : 'bg-white bg-opacity-50'
                            }`}
                          />
                        ))}
                      </div>
                    </>
                  )}
                </div>
              </div>
            )}

            <div className="bg-white max-w-4xl mx-auto">
              <div className="flex items-center gap-4 px-4 py-3 border-b border-navy-100">
                <button className="hover:opacity-60 transition-opacity">
                  <svg className="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                  </svg>
                </button>
                <button className="hover:opacity-60 transition-opacity">
                  <svg className="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                  </svg>
                </button>
                <button onClick={handleShare} className="hover:opacity-60 transition-opacity">
                  <svg className="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                  </svg>
                </button>
                <button className="ml-auto hover:opacity-60 transition-opacity">
                  <svg className="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                  </svg>
                </button>
              </div>

              <div className="px-4 py-4">
                <div className="mb-4">
                  <span className="font-bold text-navy-900 text-lg">
                    {run.runType === 'race' ? run.raceName : run.location}
                  </span>
                </div>

                <div className="mb-4">
                  <div className="text-4xl font-bold text-navy-900 mb-2">
                    {formatTime(run.time)}
                  </div>
                  <div className="text-sm text-navy-600">
                    {getDistanceLabel()} Â· {new Date(run.date).toLocaleDateString('ko-KR', { 
                      year: 'numeric',
                      month: 'long', 
                      day: 'numeric' 
                    })}
                  </div>
                </div>

                {run.memo && (
                  <p className="text-sm text-navy-700 mb-4 leading-relaxed">{run.memo}</p>
                )}

                <p className="text-xs text-navy-400">
                  ê²Œì‹œ: {run.createdAt?.toDate ? 
                    run.createdAt.toDate().toLocaleDateString('ko-KR', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric',
                      hour: '2-digit',
                      minute: '2-digit'
                    }) :
                    new Date(run.createdAt).toLocaleDateString('ko-KR', {
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric',
                      hour: '2-digit',
                      minute: '2-digit'
                    })
                  }
                </p>
              </div>
            </div>
          </div>

          {showDeleteConfirm && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-xl p-6 max-w-sm slide-up">
                <h3 className="text-lg font-bold text-navy-900 mb-2">ê¸°ë¡ ì‚­ì œ</h3>
                <p className="text-navy-600 mb-4 text-sm">ì´ ê¸°ë¡ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                <div className="flex gap-2">
                  <button
                    onClick={handleDelete}
                    className="flex-1 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition-colors text-sm font-semibold"
                  >
                    ì‚­ì œ
                  </button>
                  <button
                    onClick={() => setShowDeleteConfirm(false)}
                    className="flex-1 bg-navy-100 text-navy-700 py-2 rounded-lg hover:bg-navy-200 transition-colors text-sm font-semibold"
                  >
                    ì·¨ì†Œ
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    const AddRunForm = ({ user, onRunAdded, editingRun, onEditComplete }) => {
      const [isOpen, setIsOpen] = useState(false);
      const [runType, setRunType] = useState('race');
      const [formData, setFormData] = useState({
        date: new Date().toISOString().split('T')[0],
        distanceType: '5K',
        customDistance: '',
        hours: '0',
        minutes: '0',
        seconds: '0',
        location: '',
        raceName: '',
        memo: '',
        isPublic: true
      });
      const [photos, setPhotos] = useState([]);
      const [photoPreviews, setPhotoPreviews] = useState([]);
      const [availableRaces, setAvailableRaces] = useState([]);
      const [loading, setLoading] = useState(false);

      useEffect(() => {
        if (editingRun) {
          setIsOpen(true);
          setRunType(editingRun.runType);
          
          const timeHours = Math.floor(editingRun.time / 3600);
          const timeMinutes = Math.floor((editingRun.time % 3600) / 60);
          const timeSeconds = editingRun.time % 60;

          setFormData({
            date: editingRun.date,
            distanceType: editingRun.raceType || 'CUSTOM',
            customDistance: editingRun.raceType === 'CUSTOM' ? editingRun.distance.toString() : '',
            hours: timeHours.toString(),
            minutes: timeMinutes.toString(),
            seconds: timeSeconds.toString(),
            location: editingRun.location || '',
            raceName: editingRun.raceName || '',
            memo: editingRun.memo || '',
            isPublic: editingRun.isPublic !== false
          });

          setPhotoPreviews(editingRun.photos || []);
          setPhotos([]);
        }
      }, [editingRun]);

      useEffect(() => {
        if (runType === 'race' && formData.date) {
          const races = RACE_DATABASE.filter(race => race.date === formData.date);
          setAvailableRaces(races);
        }
      }, [runType, formData.date]);

      const handlePhotoChange = async (e) => {
        const files = Array.from(e.target.files);
        const currentPhotoCount = photoPreviews.length + photos.length;
        
        if (currentPhotoCount + files.length > 3) {
          alert('ì‚¬ì§„ì€ ìµœëŒ€ 3ì¥ê¹Œì§€ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
          return;
        }
        
        setPhotos([...photos, ...files]);
        const previews = await Promise.all(files.map(file => {
          return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.readAsDataURL(file);
          });
        }));
        setPhotoPreviews([...photoPreviews, ...previews]);
      };

      const removePhoto = (index) => {
        setPhotos(photos.filter((_, i) => i !== index));
        setPhotoPreviews(photoPreviews.filter((_, i) => i !== index));
      };

      const handleClose = () => {
        setIsOpen(false);
        setFormData({
          date: new Date().toISOString().split('T')[0],
          distanceType: '5K',
          customDistance: '',
          hours: '0',
          minutes: '0',
          seconds: '0',
          location: '',
          raceName: '',
          memo: '',
          isPublic: true
        });
        setPhotos([]);
        setPhotoPreviews([]);
        if (editingRun) {
          onEditComplete();
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);

        try {
          const totalSeconds = parseInt(formData.hours) * 3600 + 
                              parseInt(formData.minutes) * 60 + 
                              parseInt(formData.seconds);
          
          let distance;
          let raceType;
          
          if (formData.distanceType === 'CUSTOM') {
            distance = parseFloat(formData.customDistance);
            raceType = 'CUSTOM';
          } else {
            distance = RACE_TYPES[formData.distanceType];
            raceType = formData.distanceType;
          }

          const photoURLs = [];
          
          const existingPhotos = photoPreviews.filter(p => p.startsWith('http'));
          photoURLs.push(...existingPhotos);
          
          for (const photo of photos) {
            const compressed = await compressImage(photo);
            const photoRef = ref(storage, `runs/${user.uid}/${Date.now()}_${Math.random()}`);
            await uploadBytes(photoRef, compressed);
            const url = await getDownloadURL(photoRef);
            photoURLs.push(url);
          }

          const runData = {
            userId: user.uid,
            runType,
            date: formData.date,
            distance,
            time: totalSeconds,
            pace: calculatePace(distance, totalSeconds),
            location: runType === 'casual' ? formData.location : '',
            raceName: runType === 'race' ? formData.raceName : '',
            memo: formData.memo,
            photos: photoURLs,
            isPublic: formData.isPublic,
            raceType,
            ...(editingRun ? {} : { createdAt: Timestamp.now() })
          };

          if (editingRun) {
            await updateDoc(doc(db, 'runs', editingRun.id), runData);
            onEditComplete();
          } else {
            await addDoc(collection(db, 'runs'), runData);
            onRunAdded();
          }
          
          handleClose();
        } catch (error) {
          console.error('ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨:', error);
          alert('ê¸°ë¡ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        } finally {
          setLoading(false);
        }
      };

      return (
        <>
          <button
            onClick={() => setIsOpen(true)}
            className="fixed bottom-8 right-8 w-14 h-14 bg-navy-700 text-white rounded-full shadow-xl hover:bg-navy-800 transition-all duration-300 flex items-center justify-center z-50"
          >
            <svg className="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
            </svg>
          </button>

          {isOpen && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                <div className="flex justify-between items-center p-6 border-b border-navy-100">
                  <h2 className="text-2xl font-bold text-navy-900">{editingRun ? 'ê¸°ë¡ ìˆ˜ì •' : 'ìƒˆ ê¸°ë¡ ì¶”ê°€'}</h2>
                  <button
                    onClick={handleClose}
                    className="text-navy-400 hover:text-navy-600 transition-colors"
                  >
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>

                <form onSubmit={handleSubmit} className="p-6 space-y-5">
                  <div>
                    <label className="block text-sm font-semibold text-navy-700 mb-2">êµ¬ë¶„</label>
                    <div className="flex gap-2">
                      <button
                        type="button"
                        onClick={() => setRunType('race')}
                        className={`flex-1 py-3 rounded-lg font-semibold transition-colors ${
                          runType === 'race'
                            ? 'bg-navy-700 text-white'
                            : 'bg-navy-100 text-navy-600 hover:bg-navy-200'
                        }`}
                      >
                        ëŒ€íšŒ
                      </button>
                      <button
                        type="button"
                        onClick={() => setRunType('casual')}
                        className={`flex-1 py-3 rounded-lg font-semibold transition-colors ${
                          runType === 'casual'
                            ? 'bg-navy-700 text-white'
                            : 'bg-navy-100 text-navy-600 hover:bg-navy-200'
                        }`}
                      >
                        ì¼ìƒ
                      </button>
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-navy-700 mb-2">ë‚ ì§œ</label>
                    <input
                      type="date"
                      value={formData.date}
                      onChange={(e) => setFormData({...formData, date: e.target.value})}
                      className="w-full px-4 py-3 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none"
                      required
                    />
                  </div>

                  {runType === 'race' && (
                    <div>
                      <label className="block text-sm font-semibold text-navy-700 mb-2">ëŒ€íšŒëª…</label>
                      <select
                        value={formData.raceName}
                        onChange={(e) => setFormData({...formData, raceName: e.target.value})}
                        className="w-full px-4 py-3 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none"
                        required
                      >
                        <option value="">ëŒ€íšŒë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        {availableRaces.map(race => (
                          <option key={race.id} value={race.name}>{race.name}</option>
                        ))}
                      </select>
                    </div>
                  )}

                  {runType === 'casual' && (
                    <div>
                      <label className="block text-sm font-semibold text-navy-700 mb-2">ì¥ì†Œ</label>
                      <input
                        type="text"
                        value={formData.location}
                        onChange={(e) => setFormData({...formData, location: e.target.value})}
                        className="w-full px-4 py-3 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none"
                        placeholder="ì˜¬ë¦¼í”½ê³µì›"
                        required
                      />
                    </div>
                  )}

                  <div>
                    <label className="block text-sm font-semibold text-navy-700 mb-2">ê±°ë¦¬</label>
                    <div className="grid grid-cols-5 gap-2 mb-2">
                      {['5K', '10K', 'HALF', 'FULL', 'CUSTOM'].map(type => (
                        <button
                          key={type}
                          type="button"
                          onClick={() => setFormData({...formData, distanceType: type})}
                          className={`py-2 rounded-lg font-semibold text-sm transition-colors ${
                            formData.distanceType === type
                              ? 'bg-navy-700 text-white'
                              : 'bg-navy-100 text-navy-600 hover:bg-navy-200'
                          }`}
                        >
                          {type === 'CUSTOM' ? 'ì§ì ‘ì…ë ¥' : type}
                        </button>
                      ))}
                    </div>
                    {formData.distanceType === 'CUSTOM' && (
                      <input
                        type="number"
                        step="0.01"
                        value={formData.customDistance}
                        onChange={(e) => setFormData({...formData, customDistance: e.target.value})}
                        className="w-full px-4 py-3 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none"
                        placeholder="ê±°ë¦¬ ì…ë ¥ (km)"
                        required
                      />
                    )}
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-navy-700 mb-2">ê¸°ë¡ ì‹œê°„</label>
                    <div className="grid grid-cols-3 gap-3">
                      <div>
                        <input
                          type="number"
                          min="0"
                          value={formData.hours}
                          onChange={(e) => setFormData({...formData, hours: e.target.value})}
                          className="w-full px-4 py-3 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none text-center"
                        />
                        <div className="text-xs text-navy-500 text-center mt-1">ì‹œê°„</div>
                      </div>
                      <div>
                        <input
                          type="number"
                          min="0"
                          max="59"
                          value={formData.minutes}
                          onChange={(e) => setFormData({...formData, minutes: e.target.value})}
                          className="w-full px-4 py-3 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none text-center"
                        />
                        <div className="text-xs text-navy-500 text-center mt-1">ë¶„</div>
                      </div>
                      <div>
                        <input
                          type="number"
                          min="0"
                          max="59"
                          value={formData.seconds}
                          onChange={(e) => setFormData({...formData, seconds: e.target.value})}
                          className="w-full px-4 py-3 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none text-center"
                        />
                        <div className="text-xs text-navy-500 text-center mt-1">ì´ˆ</div>
                      </div>
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-navy-700 mb-2">ì‚¬ì§„ (ìµœëŒ€ 3ì¥)</label>
                    <div className="grid grid-cols-3 gap-2">
                      {photoPreviews.map((preview, idx) => (
                        <div key={idx} className="image-upload-container has-image">
                          <img src={preview} alt={`Photo ${idx}`} className="image-preview" />
                          <button
                            type="button"
                            onClick={() => removePhoto(idx)}
                            className="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600"
                          >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                            </svg>
                          </button>
                        </div>
                      ))}
                      {photos.length < 3 && (
                        <div className="image-upload-container" onClick={() => document.getElementById('photo-input').click()}>
                          <div className="upload-placeholder">
                            <svg className="w-10 h-10 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                            </svg>
                            <p className="text-xs">ì‚¬ì§„ ì¶”ê°€</p>
                          </div>
                        </div>
                      )}
                    </div>
                    <input
                      id="photo-input"
                      type="file"
                      accept="image/*"
                      multiple
                      onChange={handlePhotoChange}
                      className="hidden"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-navy-700 mb-2">ë©”ëª¨</label>
                    <textarea
                      value={formData.memo}
                      onChange={(e) => setFormData({...formData, memo: e.target.value})}
                      className="w-full px-4 py-3 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none"
                      rows="3"
                      placeholder="ì˜¤ëŠ˜ì˜ ë‹¬ë¦¬ê¸°ëŠ” ì–´ë• ë‚˜ìš”?"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-navy-700 mb-2">ê³µê°œ ì„¤ì •</label>
                    <div className="flex gap-2">
                      <button
                        type="button"
                        onClick={() => setFormData({...formData, isPublic: true})}
                        className={`flex-1 py-3 rounded-lg font-semibold transition-colors ${
                          formData.isPublic
                            ? 'bg-navy-700 text-white'
                            : 'bg-navy-100 text-navy-600 hover:bg-navy-200'
                        }`}
                      >
                        ê³µê°œ
                      </button>
                      <button
                        type="button"
                        onClick={() => setFormData({...formData, isPublic: false})}
                        className={`flex-1 py-3 rounded-lg font-semibold transition-colors ${
                          !formData.isPublic
                            ? 'bg-navy-700 text-white'
                            : 'bg-navy-100 text-navy-600 hover:bg-navy-200'
                        }`}
                      >
                        ë¹„ê³µê°œ
                      </button>
                    </div>
                  </div>

                  <button
                    type="submit"
                    disabled={loading}
                    className="w-full bg-navy-700 text-white font-semibold py-4 rounded-lg hover:bg-navy-800 transition-colors disabled:opacity-50"
                  >
                    {loading ? 'ì €ì¥ ì¤‘...' : (editingRun ? 'ìˆ˜ì • ì™„ë£Œ' : 'ê¸°ë¡ ì €ì¥')}
                  </button>
                </form>
              </div>
            </div>
          )}
        </>
      );
    };

    const Feed = ({ user, userData }) => {
      const [runs, setRuns] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showSettings, setShowSettings] = useState(false);
      const [selectedRun, setSelectedRun] = useState(null);
      const [editingRun, setEditingRun] = useState(null);

      const loadRuns = async () => {
        try {
          setLoading(true);
          const q = query(
            collection(db, 'runs'),
            where('userId', '==', user.uid),
            orderBy('date', 'desc')
          );
          const querySnapshot = await getDocs(q);
          const runsData = querySnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          setRuns(runsData);
        } catch (error) {
          console.error('ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        } finally {
          setLoading(false);
        }
      };

      useEffect(() => {
        loadRuns();
      }, [user]);

      const handleSignOut = async () => {
        try {
          await signOut(auth);
        } catch (error) {
          console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
        }
      };

      const handleEdit = (run) => {
        setSelectedRun(null);
        setEditingRun(run);
      };

      return (
        <div>
          <Profile user={user} userData={userData} runs={runs} />
          <PersonalRecords runs={runs} />
          
          {loading ? (
            <div className="text-center py-12">
              <div className="inline-block animate-spin rounded-full h-10 w-10 border-4 border-navy-700 border-t-transparent"></div>
              <p className="mt-4 text-navy-600 text-sm">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
          ) : runs.length === 0 ? (
            <div className="text-center py-12 bg-white rounded-xl shadow-sm">
              <div className="text-5xl mb-3">ğŸƒ</div>
              <h3 className="text-lg font-bold text-navy-900 mb-2">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</h3>
              <p className="text-sm text-navy-600">ì²« ë²ˆì§¸ ë‹¬ë¦¬ê¸° ê¸°ë¡ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
            </div>
          ) : (
            <div className="grid grid-cols-3 gap-1">
              {runs.map(run => (
                <RunCard 
                  key={run.id} 
                  run={run}
                  onClick={() => setSelectedRun(run)}
                />
              ))}
            </div>
          )}

          <AddRunForm user={user} onRunAdded={loadRuns} editingRun={editingRun} onEditComplete={() => {
            setEditingRun(null);
            loadRuns();
          }} />

          {showSettings && (
            <SettingsModal
              user={user}
              userData={userData}
              onClose={() => setShowSettings(false)}
              onSignOut={handleSignOut}
            />
          )}

          {selectedRun && (
            <RunDetailModal
              run={selectedRun}
              onClose={() => setSelectedRun(null)}
              onDelete={loadRuns}
              onEdit={handleEdit}
            />
          )}

          <button
            id="add-run-trigger"
            onClick={() => document.querySelector('.fixed.bottom-8.right-8').click()}
            className="hidden"
          />
          <button
            id="settings-trigger"
            onClick={() => setShowSettings(true)}
            className="hidden"
          />
        </div>
      );
    };

    const App = () => {
      const [user, setUser] = useState(null);
      const [userData, setUserData] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, async (user) => {
          setUser(user);
          
          if (user) {
            try {
              const userDoc = await getDoc(doc(db, 'users', user.uid));
              if (userDoc.exists()) {
                setUserData(userDoc.data());
              }
            } catch (error) {
              console.error('ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
          }
          
          setLoading(false);
        });

        return () => unsubscribe();
      }, []);

      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-navy-800 via-navy-700 to-navy-600">
            <div className="text-white text-xl font-semibold">Loading...</div>
          </div>
        );
      }

      if (!user) {
        return <AuthForm onAuthSuccess={() => {}} />;
      }

      return (
        <div className="min-h-screen bg-navy-50">
          <header className="bg-white shadow-sm sticky top-0 z-40">
            <div className="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
              <h1 className="text-2xl font-bold text-navy-900">RunLog</h1>
              <div className="flex items-center gap-3">
                <button
                  onClick={() => document.getElementById('add-run-trigger').click()}
                  className="w-8 h-8 bg-white border-2 border-navy-700 text-navy-700 rounded-full hover:bg-navy-50 transition-all duration-300 flex items-center justify-center"
                >
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M12 4v16m8-8H4" />
                  </svg>
                </button>
                <button
                  onClick={() => document.getElementById('settings-trigger').click()}
                  className="text-navy-700 hover:text-navy-900 transition-colors"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
                  </svg>
                </button>
              </div>
            </div>
          </header>

          <main className="max-w-4xl mx-auto px-4 py-6">
            <Feed user={user} userData={userData} />
          </main>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
