<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RunLog - ëŸ¬ë‹ ê¸°ë¡ ì•„ì¹´ì´ë¸Œ</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * {
      font-family: 'Inter', sans-serif;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .auth-card {
      animation: fadeIn 0.5s ease-out;
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .slide-up {
      animation: slideUp 0.3s ease-out;
    }
    
    @keyframes rollUp {
      0% {
        transform: translateY(0);
      }
      100% {
        transform: translateY(-100%);
      }
    }
    
    .roll-animation {
      animation: rollUp 0.5s ease-in-out;
    }
    
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f5f9;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #64748b;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #475569;
    }
    
    .image-upload-container {
      position: relative;
      width: 100%;
      aspect-ratio: 1;
      border: 2px dashed #cbd5e1;
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .image-upload-container:hover {
      border-color: #1e40af;
      background-color: #f8fafc;
    }
    
    .image-upload-container.has-image {
      border: none;
    }
    
    .image-preview {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .upload-placeholder {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #94a3b8;
    }
  </style>
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f0f9ff',
              100: '#e0f2fe',
              200: '#bae6fd',
              300: '#7dd3fc',
              400: '#38bdf8',
              500: '#0ea5e9',
              600: '#0284c7',
              700: '#0369a1',
              800: '#075985',
              900: '#0c4a6e',
            },
            navy: {
              50: '#f8fafc',
              100: '#f1f5f9',
              200: '#e2e8f0',
              300: '#cbd5e1',
              400: '#94a3b8',
              500: '#64748b',
              600: '#475569',
              700: '#334155',
              800: '#1e293b',
              900: '#0f172a',
            }
          }
        }
      }
    }
  </script>
</head>
<body class="bg-navy-50">
  <div id="root"></div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged,
      updateProfile,
      updatePassword,
      sendPasswordResetEmail
    } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      query, 
      where, 
      orderBy, 
      getDocs,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      deleteDoc,
      Timestamp 
    } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
    import { 
      getStorage, 
      ref, 
      uploadBytes, 
      getDownloadURL 
    } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js';

    const firebaseConfig = {
      apiKey: "AIzaSyA4KFdLVKVy6WdAfTGuLWDJsV_tcuNp7kw",
      authDomain: "run-log-31420.firebaseapp.com",
      projectId: "run-log-31420",
      storageBucket: "run-log-31420.firebasestorage.app",
      messagingSenderId: "325067679087",
      appId: "1:325067679087:web:727201211a34ac6c1fb49a",
      measurementId: "G-ZR1WW86K4Z"
    };

    const app = initializeApp(firebaseConfig);
    window.firebaseAuth = getAuth(app);
    window.firebaseDb = getFirestore(app);
    window.firebaseStorage = getStorage(app);
    window.firebaseModules = {
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged,
      updateProfile,
      updatePassword,
      sendPasswordResetEmail,
      collection,
      addDoc,
      query,
      where,
      orderBy,
      getDocs,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      deleteDoc,
      Timestamp,
      ref,
      uploadBytes,
      getDownloadURL
    };
  </script>

  <!-- Image Compression Library -->
  <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.min.js"></script>

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const auth = window.firebaseAuth;
    const db = window.firebaseDb;
    const storage = window.firebaseStorage;
    const {
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged,
      updateProfile,
      updatePassword,
      sendPasswordResetEmail,
      collection,
      addDoc,
      query,
      where,
      orderBy,
      getDocs,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      deleteDoc,
      Timestamp,
      ref,
      uploadBytes,
      getDownloadURL
    } = window.firebaseModules;

    // ì„ì‹œ ëŒ€íšŒ ë°ì´í„°
    const RACE_DATABASE = [
      { id: 1, name: 'ì„œìš¸êµ­ì œë§ˆë¼í†¤', date: '2025-03-16' },
      { id: 2, name: 'ë™ì•„ë§ˆë¼í†¤', date: '2025-03-23' },
      { id: 3, name: 'ì¤‘ì•™ì„œìš¸ë§ˆë¼í†¤', date: '2025-11-03' },
      { id: 4, name: 'ì¶˜ì²œë§ˆë¼í†¤', date: '2025-10-26' },
      { id: 5, name: 'ëŒ€êµ¬êµ­ì œë§ˆë¼í†¤', date: '2025-04-06' },
    ];

    const RACE_TYPES = {
      '5K': 5,
      '10K': 10,
      'HALF': 21.0975,
      'FULL': 42.195,
      'CUSTOM': null
    };

    const formatTime = (seconds) => {
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      
      if (hours > 0) {
        return `${hours}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      }
      return `${minutes}:${String(secs).padStart(2, '0')}`;
    };

    const calculatePace = (distanceKm, timeSeconds) => {
      const paceSeconds = timeSeconds / distanceKm;
      const minutes = Math.floor(paceSeconds / 60);
      const seconds = Math.floor(paceSeconds % 60);
      return `${minutes}:${String(seconds).padStart(2, '0')}`;
    };

    const determineRaceType = (distance) => {
      const tolerance = 0.1;
      
      for (const [type, standardDistance] of Object.entries(RACE_TYPES)) {
        if (standardDistance && Math.abs(distance - standardDistance) <= tolerance) {
          return type;
        }
      }
      return 'CUSTOM';
    };

    // ì´ë¯¸ì§€ ì••ì¶• í•¨ìˆ˜
    const compressImage = async (file) => {
      const options = {
        maxSizeMB: 0.5,
        maxWidthOrHeight: 1920,
        useWebWorker: true
      };
      try {
        return await imageCompression(file, options);
      } catch (error) {
        console.error('ì´ë¯¸ì§€ ì••ì¶• ì‹¤íŒ¨:', error);
        return file;
      }
    };

    // ë‹‰ë„¤ì„ ì¤‘ë³µ ì²´í¬
    const checkNicknameExists = async (nickname) => {
      const q = query(collection(db, 'users'), where('nickname', '==', nickname));
      const querySnapshot = await getDocs(q);
      return !querySnapshot.empty;
    };

    // ë¹„ë°€ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬
    const validatePassword = (password) => {
      const regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*[!@#$%^&*]).{8,}$/;
      return regex.test(password);
    };

    const AuthForm = ({ onAuthSuccess }) => {
      const [isLogin, setIsLogin] = useState(true);
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [passwordConfirm, setPasswordConfirm] = useState('');
      const [nickname, setNickname] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);
      const [showPasswordReset, setShowPasswordReset] = useState(false);
      const [resetEmail, setResetEmail] = useState('');
      const [showSuccessModal, setShowSuccessModal] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          if (isLogin) {
            await signInWithEmailAndPassword(auth, email, password);
          } else {
            // íšŒì›ê°€ì… ìœ íš¨ì„± ê²€ì‚¬
            if (!validatePassword(password)) {
              setError('ë¹„ë°€ë²ˆí˜¸ëŠ” ëŒ€ì†Œë¬¸ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ í¬í•¨í•˜ì—¬ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
              setLoading(false);
              return;
            }
            
            if (password !== passwordConfirm) {
              setError('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
              setLoading(false);
              return;
            }

            // ë‹‰ë„¤ì„ ì¤‘ë³µ ì²´í¬
            const nicknameExists = await checkNicknameExists(nickname);
            if (nicknameExists) {
              setError('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.');
              setLoading(false);
              return;
            }

            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            
            // Firestoreì— ì‚¬ìš©ì ì •ë³´ ì €ì¥
            await setDoc(doc(db, 'users', userCredential.user.uid), {
              nickname,
              email,
              createdAt: Timestamp.now()
            });

            await updateProfile(userCredential.user, { displayName: nickname });
            
            // íšŒì›ê°€ì… ì„±ê³µ ëª¨ë‹¬ í‘œì‹œ
            setShowSuccessModal(true);
            setTimeout(() => {
              setShowSuccessModal(false);
              onAuthSuccess();
            }, 2000);
          }
        } catch (err) {
          if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password' || err.code === 'auth/invalid-credential') {
            setError('ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ í•œ ë²ˆ í™•ì¸í•´ì£¼ì„¸ìš”.');
          } else if (err.code === 'auth/email-already-in-use') {
            setError('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.');
          } else {
            setError('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          }
        } finally {
          setLoading(false);
        }
      };

      const handlePasswordReset = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          await sendPasswordResetEmail(auth, resetEmail);
          alert('ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì´ë©”ì¼ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
          setShowPasswordReset(false);
          setResetEmail('');
        } catch (err) {
          setError('ì´ë©”ì¼ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
        } finally {
          setLoading(false);
        }
      };

      return (
        <>
          <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-navy-800 via-navy-700 to-navy-600 p-4">
            <div className="auth-card bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
              <div className="text-center mb-8">
                <h1 className="text-4xl font-bold mb-2 text-navy-900">
                  RunLog
                </h1>
                <p className="text-navy-600 text-base">ë‹¹ì‹ ì˜ ëŸ¬ë‹ ì—¬ì •ì„ ê¸°ë¡í•˜ì„¸ìš”</p>
              </div>

              <form onSubmit={handleSubmit} className="space-y-4">
                {!isLogin && (
                  <div>
                    <label className="block text-sm font-semibold text-navy-700 mb-2">ë‹‰ë„¤ì„</label>
                    <input
                      type="text"
                      value={nickname}
                      onChange={(e) => setNickname(e.target.value)}
                      className="w-full px-4 py-3 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none transition-colors"
                      required
                    />
                  </div>
                )}
                
                <div>
                  <label className="block text-sm font-semibold text-navy-700 mb-2">ì´ë©”ì¼</label>
                  <input
                    type="email"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    className="w-full px-4 py-3 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none transition-colors"
                    required
                  />
                </div>

                <div>
                  <label className="block text-sm font-semibold text-navy-700 mb-2">ë¹„ë°€ë²ˆí˜¸</label>
                  <input
                    type="password"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    className="w-full px-4 py-3 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none transition-colors"
                    required
                  />
                  {!isLogin && (
                    <p className="text-xs text-navy-500 mt-1">ëŒ€ì†Œë¬¸ì, íŠ¹ìˆ˜ë¬¸ì í¬í•¨ 8ì ì´ìƒ</p>
                  )}
                </div>

                {!isLogin && (
                  <div>
                    <label className="block text-sm font-semibold text-navy-700 mb-2">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                    <input
                      type="password"
                      value={passwordConfirm}
                      onChange={(e) => setPasswordConfirm(e.target.value)}
                      className="w-full px-4 py-3 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none transition-colors"
                      required
                    />
                  </div>
                )}

                {error && (
                  <div className="bg-red-50 text-red-600 px-4 py-3 rounded-lg text-sm">
                    {error}
                  </div>
                )}

                <button
                  type="submit"
                  disabled={loading}
                  className="w-full bg-navy-700 text-white font-semibold py-3 rounded-lg hover:bg-navy-800 transition-colors disabled:opacity-50"
                >
                  {loading ? 'ì²˜ë¦¬ì¤‘...' : (isLogin ? 'ë¡œê·¸ì¸' : 'íšŒì›ê°€ì…')}
                </button>
              </form>

              <div className="mt-6 text-center space-y-2">
                <div className="text-sm text-navy-600">
                  {isLogin ? 'ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? ' : 'ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? '}
                  <button
                    onClick={() => {
                      setIsLogin(!isLogin);
                      setError('');
                    }}
                    className="text-navy-700 font-semibold hover:text-navy-900 transition-colors"
                  >
                    {isLogin ? 'íšŒì›ê°€ì…' : 'ë¡œê·¸ì¸'}
                  </button>
                </div>
                
                {isLogin && (
                  <button
                    onClick={() => setShowPasswordReset(true)}
                    className="text-sm text-navy-600 hover:text-navy-800 transition-colors"
                  >
                    ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°
                  </button>
                )}
              </div>
            </div>
          </div>

          {/* ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ëª¨ë‹¬ */}
          {showPasswordReset && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 w-full max-w-md slide-up">
                <h2 className="text-2xl font-bold text-navy-900 mb-4">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</h2>
                <form onSubmit={handlePasswordReset} className="space-y-4">
                  <div>
                    <label className="block text-sm font-semibold text-navy-700 mb-2">ì´ë©”ì¼</label>
                    <input
                      type="email"
                      value={resetEmail}
                      onChange={(e) => setResetEmail(e.target.value)}
                      className="w-full px-4 py-3 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none"
                      placeholder="ê°€ì…í•œ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”"
                      required
                    />
                  </div>
                  {error && (
                    <div className="bg-red-50 text-red-600 px-4 py-3 rounded-lg text-sm">
                      {error}
                    </div>
                  )}
                  <div className="flex gap-2">
                    <button
                      type="submit"
                      disabled={loading}
                      className="flex-1 bg-navy-700 text-white font-semibold py-3 rounded-lg hover:bg-navy-800 transition-colors"
                    >
                      ì „ì†¡
                    </button>
                    <button
                      type="button"
                      onClick={() => {
                        setShowPasswordReset(false);
                        setResetEmail('');
                        setError('');
                      }}
                      className="flex-1 bg-navy-100 text-navy-700 font-semibold py-3 rounded-lg hover:bg-navy-200 transition-colors"
                    >
                      ì·¨ì†Œ
                    </button>
                  </div>
                </form>
              </div>
            </div>
          )}

          {/* íšŒì›ê°€ì… ì„±ê³µ ëª¨ë‹¬ */}
          {showSuccessModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-8 text-center slide-up">
                <div className="text-6xl mb-4">ğŸ‰</div>
                <h2 className="text-2xl font-bold text-navy-900 mb-2">í™˜ì˜í•©ë‹ˆë‹¤!</h2>
                <p className="text-navy-600">íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
              </div>
            </div>
          )}
        </>
      );
    };

    const Profile = ({ user, userData, onUpdateProfile }) => {
      const [isEditing, setIsEditing] = useState(false);
      const [nickname, setNickname] = useState(userData?.nickname || user.displayName || '');
      const [photoFile, setPhotoFile] = useState(null);
      const [photoPreview, setPhotoPreview] = useState(user.photoURL || '');
      const [loading, setLoading] = useState(false);

      const handlePhotoChange = (e) => {
        const file = e.target.files[0];
        if (file) {
          setPhotoFile(file);
          setPhotoPreview(URL.createObjectURL(file));
        }
      };

      const handleSave = async () => {
        try {
          setLoading(true);
          let photoURL = user.photoURL;
          
          if (photoFile) {
            const compressed = await compressImage(photoFile);
            const storageRef = ref(storage, `profiles/${user.uid}`);
            await uploadBytes(storageRef, compressed);
            photoURL = await getDownloadURL(storageRef);
          }

          // ë‹‰ë„¤ì„ì´ ë³€ê²½ë˜ì—ˆìœ¼ë©´ ì¤‘ë³µ ì²´í¬
          if (nickname !== (userData?.nickname || user.displayName)) {
            const nicknameExists = await checkNicknameExists(nickname);
            if (nicknameExists) {
              alert('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.');
              setLoading(false);
              return;
            }
          }

          await updateProfile(auth.currentUser, { displayName: nickname, photoURL });
          await updateDoc(doc(db, 'users', user.uid), { nickname });
          
          onUpdateProfile();
          setIsEditing(false);
        } catch (error) {
          console.error('í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
          alert('í”„ë¡œí•„ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="bg-white rounded-xl shadow-sm p-6 mb-6">
          <div className="flex items-center gap-4">
            <div className="relative">
              <div className="w-20 h-20 rounded-full overflow-hidden bg-navy-100 border-2 border-navy-200 cursor-pointer" onClick={() => !isEditing && document.getElementById('profile-photo-input').click()}>
                <img
                  src={photoPreview || 'https://via.placeholder.com/80'}
                  alt="Profile"
                  className="w-full h-full object-cover"
                />
              </div>
              {isEditing && (
                <label className="absolute bottom-0 right-0 bg-navy-700 text-white rounded-full p-1.5 cursor-pointer hover:bg-navy-800 transition-colors">
                  <input
                    id="profile-photo-input"
                    type="file"
                    accept="image/*"
                    onChange={handlePhotoChange}
                    className="hidden"
                  />
                  <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                </label>
              )}
            </div>

            <div className="flex-1">
              {isEditing ? (
                <input
                  type="text"
                  value={nickname}
                  onChange={(e) => setNickname(e.target.value)}
                  className="w-full px-3 py-2 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none"
                  placeholder="ë‹‰ë„¤ì„"
                />
              ) : (
                <>
                  <h2 className="text-xl font-bold text-navy-900">{userData?.nickname || user.displayName}</h2>
                  <p className="text-sm text-navy-500 mt-1">ëŒ€íšŒ 0 Â· ì¼ìƒ 0</p>
                </>
              )}
            </div>

            <div>
              {isEditing ? (
                <div className="flex gap-2">
                  <button
                    onClick={handleSave}
                    disabled={loading}
                    className="px-4 py-2 bg-navy-700 text-white text-sm font-semibold rounded-lg hover:bg-navy-800 transition-colors disabled:opacity-50"
                  >
                    {loading ? 'ì €ì¥ì¤‘...' : 'ì €ì¥'}
                  </button>
                  <button
                    onClick={() => {
                      setIsEditing(false);
                      setNickname(userData?.nickname || user.displayName || '');
                      setPhotoPreview(user.photoURL || '');
                    }}
                    className="px-4 py-2 bg-navy-100 text-navy-700 text-sm font-semibold rounded-lg hover:bg-navy-200 transition-colors"
                  >
                    ì·¨ì†Œ
                  </button>
                </div>
              ) : (
                <button
                  onClick={() => setIsEditing(true)}
                  className="px-4 py-2 bg-navy-100 text-navy-700 text-sm font-semibold rounded-lg hover:bg-navy-200 transition-colors"
                >
                  í”„ë¡œí•„ ìˆ˜ì •
                </button>
              )}
            </div>
          </div>
        </div>
      );
    };

    const PersonalRecords = ({ runs }) => {
      const [currentIndex, setCurrentIndex] = useState(0);
      const [isAnimating, setIsAnimating] = useState(false);

      const calculatePRs = () => {
        const prs = {};
        
        runs.forEach(run => {
          const type = run.raceType;
          if (type !== 'CUSTOM' && type) {
            if (!prs[type] || run.time < prs[type].time) {
              prs[type] = run;
            }
          }
        });
        
        return Object.entries(prs).map(([type, run]) => ({ type, ...run }));
      };

      const prs = calculatePRs();

      useEffect(() => {
        if (prs.length > 1) {
          const interval = setInterval(() => {
            setIsAnimating(true);
            setTimeout(() => {
              setCurrentIndex((prev) => (prev + 1) % prs.length);
              setIsAnimating(false);
            }, 500);
          }, 3000);
          return () => clearInterval(interval);
        }
      }, [prs.length]);

      if (prs.length === 0) {
        return (
          <div className="bg-gradient-to-br from-navy-50 to-navy-100 rounded-xl shadow-sm p-8 mb-6 text-center">
            <div className="text-4xl mb-2">ğŸ†</div>
            <h2 className="text-lg font-bold text-navy-900 mb-1">ê°œì¸ ìµœê³  ê¸°ë¡</h2>
            <p className="text-sm text-navy-600">ì²« ê¸°ë¡ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
          </div>
        );
      }

      const currentPR = prs[currentIndex];

      return (
        <div className="bg-gradient-to-br from-navy-50 to-navy-100 rounded-xl shadow-sm p-6 mb-6">
          <h2 className="text-lg font-bold text-navy-900 mb-4 flex items-center gap-2">
            <span className="text-2xl">ğŸ†</span>
            ê°œì¸ ìµœê³  ê¸°ë¡
          </h2>
          
          <div className="bg-white rounded-lg p-6 shadow-sm overflow-hidden" style={{ height: '120px' }}>
            <div className={isAnimating ? 'roll-animation' : ''}>
              <div className="text-sm font-semibold text-navy-600 mb-1">{currentPR.type}</div>
              <div className="text-3xl font-bold text-navy-900 mb-2">{formatTime(currentPR.time)}</div>
              <div className="text-sm text-navy-600">{calculatePace(currentPR.distance, currentPR.time)}/km</div>
              <div className="text-xs text-navy-500 mt-2">
                {new Date(currentPR.date).toLocaleDateString('ko-KR')}
                {currentPR.raceName && ` Â· ${currentPR.raceName}`}
              </div>
            </div>
          </div>
          
          {prs.length > 1 && (
            <div className="flex justify-center gap-1 mt-3">
              {prs.map((_, idx) => (
                <div
                  key={idx}
                  className={`w-1.5 h-1.5 rounded-full transition-colors ${
                    idx === currentIndex ? 'bg-navy-700' : 'bg-navy-300'
                  }`}
                />
              ))}
            </div>
          )}
        </div>
      );
    };

    const AddRunForm = ({ user, onRunAdded }) => {
      const [isOpen, setIsOpen] = useState(false);
      const [runType, setRunType] = useState('race'); // 'race' or 'casual'
      const [formData, setFormData] = useState({
        date: new Date().toISOString().split('T')[0],
        distanceType: '5K',
        customDistance: '',
        hours: '0',
        minutes: '0',
        seconds: '0',
        location: '',
        raceName: '',
        isCustomRace: false,
        memo: '',
        isPublic: true
      });
      const [certificateFile, setCertificateFile] = useState(null);
      const [certificatePreview, setCertificatePreview] = useState('');
      const [photos, setPhotos] = useState([]);
      const [photoPreviews, setPhotoPreviews] = useState([]);
      const [availableRaces, setAvailableRaces] = useState([]);
      const [loading, setLoading] = useState(false);

      useEffect(() => {
        if (runType === 'race' && formData.date) {
          const races = RACE_DATABASE.filter(race => race.date === formData.date);
          setAvailableRaces(races);
        }
      }, [runType, formData.date]);

      const handlePhotoChange = async (e) => {
        const files = Array.from(e.target.files);
        if (photos.length + files.length > 3) {
          alert('ì‚¬ì§„ì€ ìµœëŒ€ 3ì¥ê¹Œì§€ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
          return;
        }
        
        setPhotos([...photos, ...files]);
        const previews = await Promise.all(files.map(file => {
          return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.readAsDataURL(file);
          });
        }));
        setPhotoPreviews([...photoPreviews, ...previews]);
      };

      const handleCertificateChange = (e) => {
        const file = e.target.files[0];
        if (file) {
          setCertificateFile(file);
          const reader = new FileReader();
          reader.onloadend = () => setCertificatePreview(reader.result);
          reader.readAsDataURL(file);
        }
      };

      const removePhoto = (index) => {
        setPhotos(photos.filter((_, i) => i !== index));
        setPhotoPreviews(photoPreviews.filter((_, i) => i !== index));
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);

        try {
          const totalSeconds = parseInt(formData.hours) * 3600 + 
                              parseInt(formData.minutes) * 60 + 
                              parseInt(formData.seconds);
          
          let distance;
          let raceType;
          
          if (formData.distanceType === 'CUSTOM') {
            distance = parseFloat(formData.customDistance);
            raceType = 'CUSTOM';
          } else {
            distance = RACE_TYPES[formData.distanceType];
            raceType = formData.distanceType;
          }

          // ê¸°ë¡ì¦ ì—…ë¡œë“œ
          let certificateURL = '';
          if (certificateFile) {
            const compressed = await compressImage(certificateFile);
            const certRef = ref(storage, `certificates/${user.uid}/${Date.now()}_certificate`);
            await uploadBytes(certRef, compressed);
            certificateURL = await getDownloadURL(certRef);
          }

          // ì‚¬ì§„ ì—…ë¡œë“œ
          const photoURLs = [];
          for (const photo of photos) {
            const compressed = await compressImage(photo);
            const photoRef = ref(storage, `runs/${user.uid}/${Date.now()}_${Math.random()}`);
            await uploadBytes(photoRef, compressed);
            const url = await getDownloadURL(photoRef);
            photoURLs.push(url);
          }

          const runData = {
            userId: user.uid,
            runType,
            date: formData.date,
            distance,
            time: totalSeconds,
            pace: calculatePace(distance, totalSeconds),
            location: runType === 'casual' ? formData.location : '',
            raceName: runType === 'race' ? formData.raceName : '',
            isCustomRace: formData.isCustomRace,
            memo: formData.memo,
            certificateURL,
            photos: photoURLs,
            isPublic: formData.isPublic,
            raceType,
            createdAt: Timestamp.now()
          };

          await addDoc(collection(db, 'runs'), runData);
          
          // í¼ ì´ˆê¸°í™”
          setFormData({
            date: new Date().toISOString().split('T')[0],
            distanceType: '5K',
            customDistance: '',
            hours: '0',
            minutes: '0',
            seconds: '0',
            location: '',
            raceName: '',
            isCustomRace: false,
            memo: '',
            isPublic: true
          });
          setCertificateFile(null);
          setCertificatePreview('');
          setPhotos([]);
          setPhotoPreviews([]);
          setIsOpen(false);
          onRunAdded();
        } catch (error) {
          console.error('ê¸°ë¡ ì¶”ê°€ ì‹¤íŒ¨:', error);
          alert('ê¸°ë¡ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        } finally {
          setLoading(false);
        }
      };

      return (
        <>
          <button
            onClick={() => setIsOpen(true)}
            className="fixed bottom-8 right-8 w-14 h-14 bg-navy-700 text-white rounded-full shadow-xl hover:bg-navy-800 transition-all duration-300 flex items-center justify-center z-50"
          >
            <svg className="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
            </svg>
          </button>

          {isOpen && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
              <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-2xl my-8">
                <div className="flex justify-between items-center mb-6">
                  <h2 className="text-2xl font-bold text-navy-900">ìƒˆ ê¸°ë¡ ì¶”ê°€</h2>
                  <button
                    onClick={() => setIsOpen(false)}
                    className="text-navy-400 hover:text-navy-600 transition-colors"
                  >
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                    </svg>
                  </button>
                </div>

                <form onSubmit={handleSubmit} className="space-y-5">
                  {/* ëŒ€íšŒ/ì¼ìƒ ì„ íƒ */}
                  <div>
                    <label className="block text-sm font-semibold text-navy-700 mb-2">êµ¬ë¶„</label>
                    <div className="flex gap-2">
                      <button
                        type="button"
                        onClick={() => setRunType('race')}
                        className={`flex-1 py-3 rounded-lg font-semibold transition-colors ${
                          runType === 'race'
                            ? 'bg-navy-700 text-white'
                            : 'bg-navy-100 text-navy-600 hover:bg-navy-200'
                        }`}
                      >
                        ëŒ€íšŒ
                      </button>
                      <button
                        type="button"
                        onClick={() => setRunType('casual')}
                        className={`flex-1 py-3 rounded-lg font-semibold transition-colors ${
                          runType === 'casual'
                            ? 'bg-navy-700 text-white'
                            : 'bg-navy-100 text-navy-600 hover:bg-navy-200'
                        }`}
                      >
                        ì¼ìƒ
                      </button>
                    </div>
                  </div>

                  {/* ë‚ ì§œ */}
                  <div>
                    <label className="block text-sm font-semibold text-navy-700 mb-2">ë‚ ì§œ</label>
                    <input
                      type="date"
                      value={formData.date}
                      onChange={(e) => setFormData({...formData, date: e.target.value})}
                      className="w-full px-4 py-3 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none"
                      required
                    />
                  </div>

                  {/* ëŒ€íšŒëª… (ëŒ€íšŒì¼ ê²½ìš°) */}
                  {runType === 'race' && (
                    <div>
                      <label className="block text-sm font-semibold text-navy-700 mb-2">ëŒ€íšŒëª…</label>
                      {availableRaces.length > 0 && !formData.isCustomRace ? (
                        <select
                          value={formData.raceName}
                          onChange={(e) => setFormData({...formData, raceName: e.target.value})}
                          className="w-full px-4 py-3 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none"
                          required
                        >
                          <option value="">ëŒ€íšŒë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                          {availableRaces.map(race => (
                            <option key={race.id} value={race.name}>{race.name}</option>
                          ))}
                          <option value="__custom__">ì§ì ‘ ì…ë ¥</option>
                        </select>
                      ) : (
                        <input
                          type="text"
                          value={formData.raceName}
                          onChange={(e) => setFormData({...formData, raceName: e.target.value, isCustomRace: true})}
                          className="w-full px-4 py-3 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none"
                          placeholder="ëŒ€íšŒëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                          required
                        />
                      )}
                    </div>
                  )}

                  {/* ì¥ì†Œ (ì¼ìƒì¼ ê²½ìš°) */}
                  {runType === 'casual' && (
                    <div>
                      <label className="block text-sm font-semibold text-navy-700 mb-2">ì¥ì†Œ</label>
                      <input
                        type="text"
                        value={formData.location}
                        onChange={(e) => setFormData({...formData, location: e.target.value})}
                        className="w-full px-4 py-3 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none"
                        placeholder="ì˜¬ë¦¼í”½ê³µì›"
                        required
                      />
                    </div>
                  )}

                  {/* ê±°ë¦¬ */}
                  <div>
                    <label className="block text-sm font-semibold text-navy-700 mb-2">ê±°ë¦¬</label>
                    <div className="grid grid-cols-5 gap-2 mb-2">
                      {['5K', '10K', 'HALF', 'FULL', 'CUSTOM'].map(type => (
                        <button
                          key={type}
                          type="button"
                          onClick={() => setFormData({...formData, distanceType: type})}
                          className={`py-2 rounded-lg font-semibold text-sm transition-colors ${
                            formData.distanceType === type
                              ? 'bg-navy-700 text-white'
                              : 'bg-navy-100 text-navy-600 hover:bg-navy-200'
                          }`}
                        >
                          {type === 'CUSTOM' ? 'ì§ì ‘ì…ë ¥' : type}
                        </button>
                      ))}
                    </div>
                    {formData.distanceType === 'CUSTOM' && (
                      <input
                        type="number"
                        step="0.01"
                        value={formData.customDistance}
                        onChange={(e) => setFormData({...formData, customDistance: e.target.value})}
                        className="w-full px-4 py-3 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none"
                        placeholder="ê±°ë¦¬ ì…ë ¥ (km)"
                        required
                      />
                    )}
                  </div>

                  {/* ì‹œê°„ */}
                  <div>
                    <label className="block text-sm font-semibold text-navy-700 mb-2">ê¸°ë¡ ì‹œê°„</label>
                    <div className="grid grid-cols-3 gap-3">
                      <div>
                        <input
                          type="number"
                          min="0"
                          value={formData.hours}
                          onChange={(e) => setFormData({...formData, hours: e.target.value})}
                          className="w-full px-4 py-3 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none text-center"
                        />
                        <div className="text-xs text-navy-500 text-center mt-1">ì‹œê°„</div>
                      </div>
                      <div>
                        <input
                          type="number"
                          min="0"
                          max="59"
                          value={formData.minutes}
                          onChange={(e) => setFormData({...formData, minutes: e.target.value})}
                          className="w-full px-4 py-3 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none text-center"
                        />
                        <div className="text-xs text-navy-500 text-center mt-1">ë¶„</div>
                      </div>
                      <div>
                        <input
                          type="number"
                          min="0"
                          max="59"
                          value={formData.seconds}
                          onChange={(e) => setFormData({...formData, seconds: e.target.value})}
                          className="w-full px-4 py-3 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none text-center"
                        />
                        <div className="text-xs text-navy-500 text-center mt-1">ì´ˆ</div>
                      </div>
                    </div>
                  </div>

                  {/* ê¸°ë¡ì¦ (ëŒ€íšŒì¼ ê²½ìš°) */}
                  {runType === 'race' && (
                    <div>
                      <label className="block text-sm font-semibold text-navy-700 mb-2">ê¸°ë¡ì¦</label>
                      <div className="image-upload-container" onClick={() => !certificatePreview && document.getElementById('certificate-input').click()}>
                        {certificatePreview ? (
                          <div className="relative w-full h-full">
                            <img src={certificatePreview} alt="Certificate" className="image-preview" />
                            <button
                              type="button"
                              onClick={(e) => {
                                e.stopPropagation();
                                setCertificateFile(null);
                                setCertificatePreview('');
                              }}
                              className="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600"
                            >
                              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                              </svg>
                            </button>
                          </div>
                        ) : (
                          <div className="upload-placeholder">
                            <svg className="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                            </svg>
                            <p className="text-sm">ê¸°ë¡ì¦ ì¶”ê°€</p>
                          </div>
                        )}
                      </div>
                      <input
                        id="certificate-input"
                        type="file"
                        accept="image/*"
                        onChange={handleCertificateChange}
                        className="hidden"
                      />
                    </div>
                  )}

                  {/* ì‚¬ì§„ */}
                  <div>
                    <label className="block text-sm font-semibold text-navy-700 mb-2">ì‚¬ì§„ (ìµœëŒ€ 3ì¥)</label>
                    <div className="grid grid-cols-3 gap-2">
                      {photoPreviews.map((preview, idx) => (
                        <div key={idx} className="image-upload-container has-image">
                          <img src={preview} alt={`Photo ${idx}`} className="image-preview" />
                          <button
                            type="button"
                            onClick={() => removePhoto(idx)}
                            className="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600"
                          >
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                            </svg>
                          </button>
                        </div>
                      ))}
                      {photos.length < 3 && (
                        <div className="image-upload-container" onClick={() => document.getElementById('photo-input').click()}>
                          <div className="upload-placeholder">
                            <svg className="w-10 h-10 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                            </svg>
                            <p className="text-xs">ì‚¬ì§„ ì¶”ê°€</p>
                          </div>
                        </div>
                      )}
                    </div>
                    <input
                      id="photo-input"
                      type="file"
                      accept="image/*"
                      multiple
                      onChange={handlePhotoChange}
                      className="hidden"
                    />
                  </div>

                  {/* ë©”ëª¨ */}
                  <div>
                    <label className="block text-sm font-semibold text-navy-700 mb-2">ë©”ëª¨</label>
                    <textarea
                      value={formData.memo}
                      onChange={(e) => setFormData({...formData, memo: e.target.value})}
                      className="w-full px-4 py-3 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none"
                      rows="3"
                      placeholder="ì˜¤ëŠ˜ì˜ ë‹¬ë¦¬ê¸°ëŠ” ì–´ë• ë‚˜ìš”?"
                    />
                  </div>

                  {/* ê³µê°œ ì—¬ë¶€ */}
                  <div>
                    <label className="block text-sm font-semibold text-navy-700 mb-2">ê³µê°œ ì„¤ì •</label>
                    <div className="flex gap-2">
                      <button
                        type="button"
                        onClick={() => setFormData({...formData, isPublic: true})}
                        className={`flex-1 py-3 rounded-lg font-semibold transition-colors ${
                          formData.isPublic
                            ? 'bg-navy-700 text-white'
                            : 'bg-navy-100 text-navy-600 hover:bg-navy-200'
                        }`}
                      >
                        ê³µê°œ
                      </button>
                      <button
                        type="button"
                        onClick={() => setFormData({...formData, isPublic: false})}
                        className={`flex-1 py-3 rounded-lg font-semibold transition-colors ${
                          !formData.isPublic
                            ? 'bg-navy-700 text-white'
                            : 'bg-navy-100 text-navy-600 hover:bg-navy-200'
                        }`}
                      >
                        ë¹„ê³µê°œ
                      </button>
                    </div>
                  </div>

                  <button
                    type="submit"
                    disabled={loading}
                    className="w-full bg-navy-700 text-white font-semibold py-4 rounded-lg hover:bg-navy-800 transition-colors disabled:opacity-50"
                  >
                    {loading ? 'ì €ì¥ ì¤‘...' : 'ê¸°ë¡ ì €ì¥'}
                  </button>
                </form>
              </div>
            </div>
          )}
        </>
      );
    };

    const RunCard = ({ run, onDelete }) => {
      const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);

      const handleDelete = async () => {
        try {
          await deleteDoc(doc(db, 'runs', run.id));
          onDelete();
        } catch (error) {
          console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
          alert('ê¸°ë¡ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      };

      return (
        <div className="bg-white rounded-xl shadow-sm overflow-hidden hover:shadow-md transition-shadow duration-300 mb-4">
          {run.photos && run.photos.length > 0 && (
            <div className="relative">
              <img
                src={run.photos[0]}
                alt="Run"
                className="w-full h-64 object-cover"
              />
              {run.photos.length > 1 && (
                <div className="absolute top-3 right-3 bg-black bg-opacity-60 text-white px-2 py-1 rounded-full text-xs font-semibold">
                  +{run.photos.length - 1}
                </div>
              )}
            </div>
          )}

          <div className="p-5">
            <div className="flex justify-between items-start mb-3">
              <div>
                <h3 className="text-lg font-bold text-navy-900 mb-1">
                  {run.runType === 'race' ? run.raceName : run.location}
                </h3>
                <p className="text-sm text-navy-500">
                  {new Date(run.date).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })}
                </p>
              </div>
              <div className="flex gap-2">
                <span className={`px-2 py-1 rounded-full text-xs font-semibold ${
                  run.runType === 'race' 
                    ? 'bg-blue-100 text-blue-700'
                    : 'bg-green-100 text-green-700'
                }`}>
                  {run.runType === 'race' ? 'ëŒ€íšŒ' : 'ì¼ìƒ'}
                </span>
                {run.raceType !== 'CUSTOM' && (
                  <span className="px-2 py-1 bg-navy-100 text-navy-700 rounded-full text-xs font-semibold">
                    {run.raceType}
                  </span>
                )}
                {!run.isPublic && (
                  <span className="px-2 py-1 bg-navy-100 text-navy-600 rounded-full text-xs font-semibold">
                    ğŸ”’
                  </span>
                )}
              </div>
            </div>

            <div className="grid grid-cols-3 gap-3 mb-4 p-3 bg-navy-50 rounded-lg">
              <div>
                <div className="text-xs text-navy-600 mb-1">ê±°ë¦¬</div>
                <div className="text-lg font-bold text-navy-900">{run.distance}km</div>
              </div>
              <div>
                <div className="text-xs text-navy-600 mb-1">ì‹œê°„</div>
                <div className="text-lg font-bold text-navy-900">{formatTime(run.time)}</div>
              </div>
              <div>
                <div className="text-xs text-navy-600 mb-1">í˜ì´ìŠ¤</div>
                <div className="text-lg font-bold text-navy-900">{run.pace}/km</div>
              </div>
            </div>

            {run.memo && (
              <p className="text-sm text-navy-700 mb-3 p-3 bg-navy-50 rounded-lg">
                {run.memo}
              </p>
            )}

            <button
              onClick={() => setShowDeleteConfirm(true)}
              className="text-xs text-red-500 hover:text-red-700 font-medium transition-colors"
            >
              ì‚­ì œ
            </button>

            {showDeleteConfirm && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-xl p-6 max-w-sm slide-up">
                  <h3 className="text-lg font-bold text-navy-900 mb-2">ê¸°ë¡ ì‚­ì œ</h3>
                  <p className="text-navy-600 mb-4 text-sm">ì´ ê¸°ë¡ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                  <div className="flex gap-2">
                    <button
                      onClick={handleDelete}
                      className="flex-1 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 transition-colors text-sm font-semibold"
                    >
                      ì‚­ì œ
                    </button>
                    <button
                      onClick={() => setShowDeleteConfirm(false)}
                      className="flex-1 bg-navy-100 text-navy-700 py-2 rounded-lg hover:bg-navy-200 transition-colors text-sm font-semibold"
                    >
                      ì·¨ì†Œ
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    const SettingsModal = ({ user, userData, onClose, onSignOut }) => {
      const [activeTab, setActiveTab] = useState('account');
      const [nickname, setNickname] = useState(userData?.nickname || user.displayName || '');
      const [currentPassword, setCurrentPassword] = useState('');
      const [newPassword, setNewPassword] = useState('');
      const [newPasswordConfirm, setNewPasswordConfirm] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);

      const handleNicknameUpdate = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          if (nickname !== (userData?.nickname || user.displayName)) {
            const nicknameExists = await checkNicknameExists(nickname);
            if (nicknameExists) {
              setError('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.');
              setLoading(false);
              return;
            }
          }

          await updateProfile(auth.currentUser, { displayName: nickname });
          await updateDoc(doc(db, 'users', user.uid), { nickname });
          
          alert('ë‹‰ë„¤ì„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
          window.location.reload();
        } catch (err) {
          setError('ë‹‰ë„¤ì„ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        } finally {
          setLoading(false);
        }
      };

      const handlePasswordUpdate = async (e) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
          if (!validatePassword(newPassword)) {
            setError('ë¹„ë°€ë²ˆí˜¸ëŠ” ëŒ€ì†Œë¬¸ì, íŠ¹ìˆ˜ë¬¸ìë¥¼ í¬í•¨í•˜ì—¬ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
            setLoading(false);
            return;
          }

          if (newPassword !== newPasswordConfirm) {
            setError('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            setLoading(false);
            return;
          }

          // ì¬ì¸ì¦ í•„ìš”
          await signInWithEmailAndPassword(auth, user.email, currentPassword);
          await updatePassword(auth.currentUser, newPassword);
          
          alert('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
          setCurrentPassword('');
          setNewPassword('');
          setNewPasswordConfirm('');
        } catch (err) {
          if (err.code === 'auth/wrong-password') {
            setError('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          } else {
            setError('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md slide-up">
            <div className="flex justify-between items-center p-6 border-b border-navy-100">
              <h2 className="text-xl font-bold text-navy-900">ë”ë³´ê¸°</h2>
              <button
                onClick={onClose}
                className="text-navy-400 hover:text-navy-600 transition-colors"
              >
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>

            <div className="flex border-b border-navy-100">
              <button
                onClick={() => setActiveTab('account')}
                className={`flex-1 py-3 text-sm font-semibold transition-colors ${
                  activeTab === 'account'
                    ? 'text-navy-900 border-b-2 border-navy-700'
                    : 'text-navy-500 hover:text-navy-700'
                }`}
              >
                ê°œì¸ ì •ë³´ ìˆ˜ì •
              </button>
            </div>

            <div className="p-6">
              {activeTab === 'account' && (
                <div className="space-y-6">
                  {/* ë‹‰ë„¤ì„ ë³€ê²½ */}
                  <form onSubmit={handleNicknameUpdate} className="space-y-3">
                    <div>
                      <label className="block text-sm font-semibold text-navy-700 mb-2">ë‹‰ë„¤ì„</label>
                      <input
                        type="text"
                        value={nickname}
                        onChange={(e) => setNickname(e.target.value)}
                        className="w-full px-4 py-2 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none text-sm"
                        required
                      />
                    </div>
                    <button
                      type="submit"
                      disabled={loading}
                      className="w-full bg-navy-700 text-white py-2 rounded-lg hover:bg-navy-800 transition-colors text-sm font-semibold disabled:opacity-50"
                    >
                      {loading ? 'ë³€ê²½ ì¤‘...' : 'ë‹‰ë„¤ì„ ë³€ê²½'}
                    </button>
                  </form>

                  <div className="border-t border-navy-100 pt-6">
                    <h3 className="text-sm font-semibold text-navy-700 mb-3">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
                    <form onSubmit={handlePasswordUpdate} className="space-y-3">
                      <input
                        type="password"
                        value={currentPassword}
                        onChange={(e) => setCurrentPassword(e.target.value)}
                        className="w-full px-4 py-2 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none text-sm"
                        placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸"
                        required
                      />
                      <input
                        type="password"
                        value={newPassword}
                        onChange={(e) => setNewPassword(e.target.value)}
                        className="w-full px-4 py-2 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none text-sm"
                        placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸"
                        required
                      />
                      <input
                        type="password"
                        value={newPasswordConfirm}
                        onChange={(e) => setNewPasswordConfirm(e.target.value)}
                        className="w-full px-4 py-2 rounded-lg border-2 border-navy-200 focus:border-navy-600 focus:outline-none text-sm"
                        placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸"
                        required
                      />
                      <p className="text-xs text-navy-500">ëŒ€ì†Œë¬¸ì, íŠ¹ìˆ˜ë¬¸ì í¬í•¨ 8ì ì´ìƒ</p>
                      
                      {error && (
                        <div className="bg-red-50 text-red-600 px-3 py-2 rounded-lg text-xs">
                          {error}
                        </div>
                      )}
                      
                      <button
                        type="submit"
                        disabled={loading}
                        className="w-full bg-navy-700 text-white py-2 rounded-lg hover:bg-navy-800 transition-colors text-sm font-semibold disabled:opacity-50"
                      >
                        {loading ? 'ë³€ê²½ ì¤‘...' : 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½'}
                      </button>
                    </form>
                  </div>

                  <div className="border-t border-navy-100 pt-6">
                    <button
                      onClick={onSignOut}
                      className="w-full bg-red-50 text-red-600 py-2 rounded-lg hover:bg-red-100 transition-colors text-sm font-semibold"
                    >
                      ë¡œê·¸ì•„ì›ƒ
                    </button>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    const Feed = ({ user, userData }) => {
      const [runs, setRuns] = useState([]);
      const [loading, setLoading] = useState(true);
      const [showSettings, setShowSettings] = useState(false);

      const loadRuns = async () => {
        try {
          setLoading(true);
          const q = query(
            collection(db, 'runs'),
            where('userId', '==', user.uid),
            orderBy('date', 'desc')
          );
          const querySnapshot = await getDocs(q);
          const runsData = querySnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          setRuns(runsData);
        } catch (error) {
          console.error('ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        } finally {
          setLoading(false);
        }
      };

      useEffect(() => {
        loadRuns();
      }, [user]);

      const handleSignOut = async () => {
        try {
          await signOut(auth);
        } catch (error) {
          console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
        }
      };

      return (
        <div>
          <PersonalRecords runs={runs} />
          
          {loading ? (
            <div className="text-center py-12">
              <div className="inline-block animate-spin rounded-full h-10 w-10 border-4 border-navy-700 border-t-transparent"></div>
              <p className="mt-4 text-navy-600 text-sm">ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
          ) : runs.length === 0 ? (
            <div className="text-center py-12 bg-white rounded-xl shadow-sm">
              <div className="text-5xl mb-3">ğŸƒ</div>
              <h3 className="text-lg font-bold text-navy-900 mb-2">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</h3>
              <p className="text-sm text-navy-600">ì²« ë²ˆì§¸ ë‹¬ë¦¬ê¸° ê¸°ë¡ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
            </div>
          ) : (
            <div className="space-y-4">
              {runs.map(run => (
                <RunCard key={run.id} run={run} onDelete={loadRuns} />
              ))}
            </div>
          )}

          <AddRunForm user={user} onRunAdded={loadRuns} />

          {showSettings && (
            <SettingsModal
              user={user}
              userData={userData}
              onClose={() => setShowSettings(false)}
              onSignOut={handleSignOut}
            />
          )}

          {/* ë”ë³´ê¸° ë²„íŠ¼ */}
          <button
            onClick={() => setShowSettings(true)}
            className="fixed top-6 right-6 text-navy-700 hover:text-navy-900 transition-colors z-40"
          >
            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
            </svg>
          </button>
        </div>
      );
    };

    const App = () => {
      const [user, setUser] = useState(null);
      const [userData, setUserData] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, async (user) => {
          setUser(user);
          
          if (user) {
            try {
              const userDoc = await getDoc(doc(db, 'users', user.uid));
              if (userDoc.exists()) {
                setUserData(userDoc.data());
              }
            } catch (error) {
              console.error('ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
          }
          
          setLoading(false);
        });

        return () => unsubscribe();
      }, []);

      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-navy-800 via-navy-700 to-navy-600">
            <div className="text-white text-xl font-semibold">Loading...</div>
          </div>
        );
      }

      if (!user) {
        return <AuthForm onAuthSuccess={() => {}} />;
      }

      return (
        <div className="min-h-screen bg-navy-50">
          <header className="bg-white shadow-sm sticky top-0 z-40">
            <div className="max-w-4xl mx-auto px-4 py-4">
              <h1 className="text-2xl font-bold text-navy-900">
                RunLog
              </h1>
            </div>
          </header>

          <main className="max-w-4xl mx-auto px-4 py-6">
            <Profile user={user} userData={userData} onUpdateProfile={() => window.location.reload()} />
            <Feed user={user} userData={userData} />
          </main>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
